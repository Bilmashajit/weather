# This is a basic workflow to help you get started with Actions
name: Main CI

# Controls when the workflow will run
on:
    # Triggers the workflow on push or pull request events but only for the "main" branch
    push:
        branches: ["main"]
        paths:
            - "force-app/**"

jobs:
    deploy-main-branch-to-main-org:
        runs-on: ubuntu-latest
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            # Install Salesforce CLI
            - name: "Install Salesforce CLI"
              run: |
                  wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
                  mkdir ~/sfdx
                  tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
                  echo "$HOME/sfdx/bin" >> $GITHUB_PATH
                  ~/sfdx/bin/sfdx version

            # Checkout the source code
            - name: "Checkout source code"
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            # Store secret for both otgs
            - name: "Populate auth file with SFDX_URL secret of the Main Development org"
              shell: bash
              run: |
                  echo ${{ secrets.SFDX_MAIN_URL}} > ./SFDX_MAIN_URL.txt

            # Authenticate to org
            - name: "Authenticate to Main Development Org"
              run: sfdx auth:sfdxurl:store -f ./SFDX_MAIN_URL.txt -a main-org -d

            # Create scratch org
            - name: "Create scratch org"
              run: sfdx force:org:create -f config/project-scratch-def.json -a ci-org -d 1

            # Deploy source to scratch org
            - name: "Push source to scratch org"
              run: sfdx force:source:push

            # Run Apex tests in scratch org
            - name: "Run Apex tests"
              run: sfdx force:apex:test:run -c -r human -d ./tests/apex -w 20
